rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ===== Existing collections =====

    match /users/{uid} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == uid;
    }

    match /announcements/{id} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }

    match /h2h/{id} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }

    // ===== Encrypted Chat =====
    //
    // Privacy model:
    //   - Only participants of a chat can read or write to it.
    //   - Even if someone gains read access to Firestore, messages are
    //     AES-256-GCM encrypted and the key is RSA-OAEP wrapped per user â€”
    //     ciphertext is useless without the recipient's private key.
    //
    // Note: the 'participants' field is set at creation and never mutated,
    //       so checking resource.data.participants is safe for reads/writes.

    match /chats/{chatId} {
      // Only participants can read chat metadata
      allow read: if request.auth != null
                  && request.auth.uid in resource.data.participants;

      // Creator can create; must include themselves as a participant
      allow create: if request.auth != null
                    && request.auth.uid in request.resource.data.participants;

      // Participants can update (e.g. lastMessageAt)
      allow update: if request.auth != null
                    && request.auth.uid in resource.data.participants;

      // Messages sub-collection
      match /messages/{msgId} {
        // Read: must be a participant of the parent chat
        allow read: if request.auth != null
                    && request.auth.uid in
                       get(/databases/$(database)/documents/chats/$(chatId)).data.participants;

        // Write: only participants can post messages
        allow create: if request.auth != null
                      && request.auth.uid in
                         get(/databases/$(database)/documents/chats/$(chatId)).data.participants
                      && request.resource.data.sender == request.auth.uid;

        // Messages are immutable once sent
        allow update, delete: if false;
      }
    }

  }
}
